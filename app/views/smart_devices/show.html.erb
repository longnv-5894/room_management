<div class="container-fluid px-4">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="mt-4">
      <i class="<%= 
        case @smart_device.device_type
        when 'smart_lock'
          'fas fa-lock'
        when 'smart_switch'
          'fas fa-toggle-on'
        when 'temperature_sensor'
          'fas fa-thermometer-half'
        else
          'fas fa-microchip'
        end
      %>"></i>
      <%= @smart_device.name %>
    </h1>
    <div>
      <% if @smart_device.building.present? %>
        <%= link_to building_smart_devices_path(@smart_device.building), class: 'btn btn-outline-secondary me-2' do %>
          <i class="fas fa-chevron-left me-1"></i> <%= t('smart_devices.common.back_to_list') %>
        <% end %>
      <% else %>
        <%= link_to smart_devices_path, class: 'btn btn-outline-secondary me-2' do %>
          <i class="fas fa-chevron-left me-1"></i> <%= t('smart_devices.common.back_to_list') %>
        <% end %>
      <% end %>
      
      <%= link_to edit_smart_device_path(@smart_device), class: 'btn btn-primary' do %>
        <i class="fas fa-edit me-1"></i> <%= t('smart_devices.common.edit') %>
      <% end %>
    </div>
  </div>

  <div class="row mb-4">
    <div class="col-xl-3 col-md-6 mb-4">
      <div class="card border-0 shadow h-100 py-2">
        <div class="card-body">
          <div class="row no-gutters align-items-center">
            <div class="col mr-2">
              <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                <%= t('smart_devices.common.device_type') %></div>
              <div class="h5 mb-0 font-weight-bold text-gray-800">
                <%= 
                  case @smart_device.device_type
                  when 'smart_lock'
                    t('smart_devices.types.smart_lock')
                  when 'smart_switch'
                    t('smart_devices.types.smart_switch')
                  when 'temperature_sensor'
                    t('smart_devices.types.temperature_sensor')
                  else
                    t('smart_devices.types.smart_device')
                  end
                %>
              </div>
            </div>
            <div class="col-auto">
              <i class="<%= 
                case @smart_device.device_type
                when 'smart_lock'
                  'fas fa-lock'
                when 'smart_switch'
                  'fas fa-toggle-on'
                when 'temperature_sensor'
                  'fas fa-thermometer-half'
                else
                  'fas fa-microchip'
                end
              %> fa-2x text-gray-300"></i>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-4">
      <div class="card border-0 shadow h-100 py-2">
        <div class="card-body">
          <div class="row no-gutters align-items-center">
            <div class="col mr-2">
              <div class="text-xs font-weight-bold text-info text-uppercase mb-1">
                <%= t('smart_devices.common.status') %></div>
              <div class="h5 mb-0 font-weight-bold">
                <span class="badge <%= @smart_device.online? ? 'bg-success' : 'bg-danger' %> rounded-pill">
                  <%= @smart_device.online? ? t('smart_devices.common.online') : t('smart_devices.common.offline') %>
                </span>
              </div>
            </div>
            <div class="col-auto">
              <i class="fas fa-wifi fa-2x text-gray-300"></i>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-4">
      <div class="card border-0 shadow h-100 py-2">
        <div class="card-body">
          <div class="row no-gutters align-items-center">
            <div class="col mr-2">
              <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
                <%= t('smart_devices.common.last_update') %></div>
              <div class="h5 mb-0 font-weight-bold text-gray-800">
                <%= @smart_device.updated_at.strftime("%H:%M %d/%m/%Y") %>
              </div>
            </div>
            <div class="col-auto">
              <i class="fas fa-clock fa-2x text-gray-300"></i>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-4">
      <div class="card border-0 shadow h-100 py-2">
        <div class="card-body">
          <div class="row no-gutters align-items-center">
            <div class="col mr-2">
              <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                <%= t('smart_devices.common.room') %></div>
              <div class="h5 mb-0 font-weight-bold text-gray-800">
                <% if @smart_device.room.present? %>
                  <%= link_to @smart_device.room.number, room_path(@smart_device.room), class: "text-decoration-none" %>
                <% else %>
                  <span class="text-muted"><%= t('smart_devices.common.not_assigned') %></span>
                <% end %>
              </div>
            </div>
            <div class="col-auto">
              <i class="fas fa-door-open fa-2x text-gray-300"></i>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="row">
    <div class="col-lg-6 col-md-12 mb-4">
      <div class="card border-0 shadow mb-4">
        <div class="card-header py-3 bg-white">
          <h6 class="m-0 font-weight-bold text-primary"><%= t('smart_devices.common.device_info') %></h6>
        </div>
        <div class="card-body">
          <table class="table table-borderless">
            <tr>
              <th class="ps-0" style="width: 150px;"><%= t('smart_devices.common.device_id') %>:</th>
              <td><code><%= @smart_device.device_id %></code></td>
            </tr>
            <tr>
              <th class="ps-0"><%= t('smart_devices.common.display_name') %>:</th>
              <td><%= @smart_device.name %></td>
            </tr>
            <tr>
              <th class="ps-0"><%= t('smart_devices.common.building') %>:</th>
              <td>
                <% if @smart_device.building.present? %>
                  <%= link_to @smart_device.building.name, building_path(@smart_device.building), class: "text-decoration-none" %>
                <% else %>
                  <span class="text-muted"><%= t('smart_devices.common.none') %></span>
                <% end %>
              </td>
            </tr>
          </table>
        </div>
      </div>

      <% if @smart_device.device_type == 'smart_lock' && @smart_device.online? %>
      <div class="card border-0 shadow">
        <div class="card-header py-3 bg-white">
          <h6 class="m-0 font-weight-bold text-primary"><%= t('smart_devices.lock.lock_status') %></h6>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-6 mb-4 mb-md-0">
              <div class="card bg-light">
                <div class="card-body text-center">
                  <h5 class="text-muted mb-3"><%= t('smart_devices.lock.current_status') %></h5>
                  <div class="mb-2">
                    <% if @smart_device.device_status == 'locked' %>
                      <i class="fas fa-lock fa-4x text-danger"></i>
                    <% else %>
                      <i class="fas fa-unlock fa-4x text-success"></i>
                    <% end %>
                  </div>
                  <div class="mt-2 h4 <%= @smart_device.device_status == 'locked' ? 'text-danger' : 'text-success' %>">
                    <%= @smart_device.device_status == 'locked' ? t('smart_devices.lock.locked') : t('smart_devices.lock.unlocked') %>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="card bg-light">
                <div class="card-body text-center">
                  <h5 class="text-muted mb-3"><%= t('smart_devices.lock.battery') %></h5>
                  <div class="mb-2">
                    <% 
                      battery = @smart_device.device_data&.dig('battery_percentage') || 0
                      battery_class = ''
                      if battery > 70
                        battery_class = 'text-success'
                      elsif battery > 30
                        battery_class = 'text-warning'
                      else
                        battery_class = 'text-danger'
                      end
                    %>
                    <i class="fas fa-battery-<%= 
                      if battery > 80
                        'full'
                      elsif battery > 60
                        'three-quarters'
                      elsif battery > 40
                        'half'
                      elsif battery > 20
                        'quarter'
                      else
                        'empty'
                      end
                    %> fa-4x <%= battery_class %>"></i>
                  </div>
                  <div class="mt-2 h4 <%= battery_class %>">
                    <%= battery %>%
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <% end %>
    </div>

    <div class="col-lg-6 col-md-12 mb-4">
      <div class="card border-0 shadow">
        <div class="card-header py-3 bg-white">
          <h6 class="m-0 font-weight-bold text-primary">
            <% case @smart_device.device_type 
              when 'smart_lock' %>
              <%= t('smart_devices.lock.lock_control') %>
            <% when 'smart_switch' %>
              <%= t('smart_devices.switch.switch_control') %>
            <% when 'temperature_sensor' %>
              <%= t('smart_devices.sensor.sensor_data') %>
            <% else %>
              <%= t('smart_devices.common_device.no_control') %>
            <% end %>
          </h6>
        </div>
        <div class="card-body">
          <% case @smart_device.device_type 
            when 'smart_lock' %>
            <% if @smart_device.online? %>
              <div class="row mb-4">
                <div class="col-md-6 mb-3 mb-md-0">
                  <%= link_to unlock_door_smart_device_path(@smart_device), method: :post, 
                      class: "card shadow-sm h-100 text-decoration-none text-white bg-warning hover-shadow transition-300" do %>
                    <div class="card-body text-center py-4">
                      <i class="fas fa-unlock-alt fa-3x mb-3"></i>
                      <h5 class="card-title"><%= t('smart_devices.lock.temp_unlock') %></h5>
                      <p class="card-text small"><%= t('smart_devices.lock.temp_unlock_desc') %></p>
                    </div>
                  <% end %>
                </div>
                <div class="col-md-6">
                  <%= link_to lock_door_smart_device_path(@smart_device), method: :post, 
                      class: "card shadow-sm h-100 text-decoration-none text-white bg-success hover-shadow transition-300" do %>
                    <div class="card-body text-center py-4">
                      <i class="fas fa-lock fa-3x mb-3"></i>
                      <h5 class="card-title"><%= t('smart_devices.lock.lock_door') %></h5>
                      <p class="card-text small"><%= t('smart_devices.lock.lock_door_desc') %></p>
                    </div>
                  <% end %>
                </div>
              </div>
            <% else %>
              <div class="alert alert-warning">
                <i class="fas fa-exclamation-triangle me-2"></i>
                <%= t('smart_devices.lock.device_offline') %>
              </div>
            <% end %>

            <div class="row">
              <div class="col-md-6 mb-3 mb-md-0">
                <%= link_to lock_users_smart_device_path(@smart_device), 
                    class: "card shadow-sm h-100 text-decoration-none text-white bg-primary hover-shadow transition-300" do %>
                  <div class="card-body text-center py-4">
                    <i class="fas fa-users fa-3x mb-3"></i>
                    <h5 class="card-title"><%= t('smart_devices.lock.user_management') %></h5>
                    <p class="card-text small"><%= t('smart_devices.lock.user_management_desc') %></p>
                  </div>
                <% end %>
              </div>
              <div class="col-md-6">
                <%= link_to unlock_records_smart_device_path(@smart_device), 
                    class: "card shadow-sm h-100 text-decoration-none text-white bg-info hover-shadow transition-300" do %>
                  <div class="card-body text-center py-4">
                    <i class="fas fa-history fa-3x mb-3"></i>
                    <h5 class="card-title"><%= t('smart_devices.lock.unlock_history') %></h5>
                    <p class="card-text small"><%= t('smart_devices.lock.unlock_history_desc') %></p>
                  </div>
                <% end %>
              </div>
            </div>
            
          <% when 'smart_switch' %>
            <% if @smart_device.online? %>
              <div class="text-center mb-4">
                <div class="device-status my-4">
                  <div class="display-1 <%= @smart_device.device_status == 'on' ? 'text-success' : 'text-muted' %>">
                    <i class="fas <%= @smart_device.device_status == 'on' ? 'fa-toggle-on' : 'fa-toggle-off' %>"></i>
                  </div>
                  <h4 class="mt-3 <%= @smart_device.device_status == 'on' ? 'text-success' : 'text-muted' %>">
                    <%= @smart_device.device_status == 'on' ? t('smart_devices.switch.on') : t('smart_devices.switch.off') %>
                  </h4>
                </div>
                
                <div class="row justify-content-center mt-5">
                  <div class="col-md-8">
                    <div class="d-flex justify-content-around">
                      <%= link_to turn_on_smart_device_path(@smart_device), method: :post, 
                          class: "btn btn-lg #{@smart_device.device_status == 'on' ? 'btn-success' : 'btn-outline-success'} px-4" do %>
                        <i class="fas fa-power-off me-2"></i> <%= t('smart_devices.switch.turn_on') %>
                      <% end %>
                      <%= link_to turn_off_smart_device_path(@smart_device), method: :post, 
                          class: "btn btn-lg #{@smart_device.device_status == 'off' ? 'btn-danger' : 'btn-outline-danger'} px-4" do %>
                        <i class="fas fa-power-off me-2"></i> <%= t('smart_devices.switch.turn_off') %>
                      <% end %>
                    </div>
                  </div>
                </div>
              </div>
            <% else %>
              <div class="alert alert-warning">
                <i class="fas fa-exclamation-triangle me-2"></i>
                <%= t('smart_devices.switch.device_offline') %>
              </div>
            <% end %>

          <% when 'temperature_sensor' %>
            <% if @smart_device.online? && @smart_device.device_data.present? %>
              <div class="row">
                <div class="col-md-6 mb-4">
                  <div class="card bg-primary text-white shadow h-100">
                    <div class="card-body text-center py-4">
                      <i class="fas fa-temperature-high fa-3x mb-3"></i>
                      <h2 class="display-4"><%= @smart_device.device_data['temperature'] || '0' %> Â°C</h2>
                      <h5 class="text-white-50 mt-3"><%= t('smart_devices.sensor.temperature') %></h5>
                    </div>
                  </div>
                </div>
                
                <% if @smart_device.device_data['humidity'].present? %>
                <div class="col-md-6 mb-4">
                  <div class="card bg-info text-white shadow h-100">
                    <div class="card-body text-center py-4">
                      <i class="fas fa-tint fa-3x mb-3"></i>
                      <h2 class="display-4"><%= @smart_device.device_data['humidity'] || '0' %> %</h2>
                      <h5 class="text-white-50 mt-3"><%= t('smart_devices.sensor.humidity') %></h5>
                    </div>
                  </div>
                </div>
                <% end %>
              </div>
            <% else %>
              <div class="alert alert-warning">
                <i class="fas fa-exclamation-triangle me-2"></i>
                <%= t('smart_devices.sensor.device_offline') %>
              </div>
            <% end %>
          <% else %>
            <div class="alert alert-info">
              <i class="fas fa-info-circle me-2"></i>
              <%= t('smart_devices.common_device.no_control') %>
            </div>
          <% end %>
        </div>
      </div>
    </div>
  </div>

  <% if @smart_device.device_type == 'smart_lock' && @device_logs.present? %>
  <div class="row">
    <div class="col-12">
      <div class="card border-0 shadow mb-4">
        <div class="card-header py-3 bg-white">
          <h6 class="m-0 font-weight-bold text-primary"><%= t('smart_devices.history.activity_history') %></h6>
        </div>
        <div class="card-body p-0">
          <div class="table-responsive">
            <table class="table table-hover mb-0">
              <thead class="table-light">
                <tr>
                  <th class="border-0"><%= t('smart_devices.history.time') %></th>
                  <th class="border-0"><%= t('smart_devices.history.event') %></th>
                  <th class="border-0"><%= t('smart_devices.history.user') %></th>
                  <th class="border-0"><%= t('smart_devices.history.notes') %></th>
                </tr>
              </thead>
              <tbody>
                <% @device_logs.each do |log| %>
                  <tr>
                    <td><%= log.created_at.strftime("%H:%M %d/%m/%Y") %></td>
                    <td>
                      <span class="badge <%= log.event_type == 'unlock' ? 'bg-success' : 'bg-danger' %>">
                        <%= log.event_type == 'unlock' ? t('smart_devices.history.unlock') : t('smart_devices.history.lock') %>
                      </span>
                    </td>
                    <td><%= log.user_name.presence || t('smart_devices.common.system') %></td>
                    <td><%= log.notes.presence || '-' %></td>
                  </tr>
                <% end %>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
  <% end %>

  <div class="row mb-4">
    <div class="col-12">
      <div class="card border-0 shadow">
        <div class="card-header py-3 bg-white">
          <h6 class="m-0 font-weight-bold text-primary"><%= t('smart_devices.management.device_management') %></h6>
        </div>
        <div class="card-body">
          <div class="d-flex">
            <%= link_to edit_smart_device_path(@smart_device), class: "btn btn-outline-primary me-2" do %>
              <i class="fas fa-edit me-1"></i> <%= t('smart_devices.common.edit_info') %>
            <% end %>

            <button type="button" class="btn btn-outline-danger" data-bs-toggle="modal" data-bs-target="#deleteDeviceModal">
              <i class="fas fa-trash-alt me-1"></i> <%= t('smart_devices.common.delete_device') %>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Delete Modal -->
<div class="modal fade" id="deleteDeviceModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><%= t('smart_devices.common.confirm_delete') %></h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p><%= t('smart_devices.common.delete_confirmation_message', name: @smart_device.name) %></p>
        <p class="text-danger"><%= t('smart_devices.common.cannot_undo') %></p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal"><%= t('smart_devices.common.cancel') %></button>
        <% if @smart_device.building.present? %>
          <%= link_to t('smart_devices.common.delete_device'), smart_device_path(@smart_device, redirect_to: 'building'), method: :delete, class: 'btn btn-danger' %>
        <% else %>
          <%= link_to t('smart_devices.common.delete_device'), smart_device_path(@smart_device), method: :delete, class: 'btn btn-danger' %>
        <% end %>
      </div>
    </div>
  </div>
</div>

<style>
  .hover-shadow:hover {
    transform: translateY(-5px);
    box-shadow: 0 .5rem 1rem rgba(0,0,0,.15)!important;
  }
  .transition-300 {
    transition: all .3s ease;
  }
</style>
