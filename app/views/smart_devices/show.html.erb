<div class="dashboard">
  <div class="page-header">
    <h1 class="header-title">
      <i class="<%= 
        case @smart_device.device_type
        when 'smart_lock'
          'fas fa-lock'
        when 'smart_switch'
          'fas fa-toggle-on'
        when 'temperature_sensor'
          'fas fa-thermometer-half'
        else
          'fas fa-microchip'
        end
      %>"></i>
      <%= @smart_device.name %>
    </h1>
    <div class="header-actions">
      <% if @smart_device.building.present? %>
        <%= link_to building_smart_devices_path(@smart_device.building), class: 'btn btn-outline-secondary me-2' do %>
          <i class="fas fa-chevron-left me-1"></i> Quay lại danh sách
        <% end %>
      <% else %>
        <%= link_to smart_devices_path, class: 'btn btn-outline-secondary me-2' do %>
          <i class="fas fa-chevron-left me-1"></i> Quay lại danh sách
        <% end %>
      <% end %>
      
      <%= link_to edit_smart_device_path(@smart_device), class: 'btn btn-primary' do %>
        <i class="fas fa-edit me-1"></i> Chỉnh sửa
      <% end %>
    </div>
  </div>

  <div class="dashboard-stats">
    <div class="stat-card">
      <div class="stat-icon">
        <% case @smart_device.device_type 
          when 'smart_lock' %>
          <i class="fas fa-lock"></i>
        <% when 'smart_switch' %>
          <i class="fas fa-toggle-on"></i>
        <% when 'temperature_sensor' %>
          <i class="fas fa-thermometer-half"></i>
        <% else %>
          <i class="fas fa-microchip"></i>
        <% end %>
      </div>
      <div class="stat-content">
        <span class="stat-label">Loại thiết bị</span>
        <span class="stat-value">
          <%= 
            case @smart_device.device_type
            when 'smart_lock'
              'Khóa thông minh'
            when 'smart_switch'
              'Công tắc thông minh'
            when 'temperature_sensor'
              'Cảm biến nhiệt độ'
            else
              'Thiết bị thông minh'
            end
          %>
        </span>
      </div>
    </div>

    <div class="stat-card">
      <div class="stat-icon">
        <i class="fas fa-wifi"></i>
      </div>
      <div class="stat-content">
        <span class="stat-label">Trạng thái</span>
        <div>
          <span class="status-badge status-<%= @smart_device.online? ? 'active' : 'inactive' %>">
            <%= @smart_device.online? ? 'Online' : 'Offline' %>
          </span>
        </div>
      </div>
    </div>

    <div class="stat-card">
      <div class="stat-icon">
        <i class="fas fa-clock"></i>
      </div>
      <div class="stat-content">
        <span class="stat-label">Cập nhật cuối</span>
        <span class="stat-value">
          <%= @smart_device.updated_at.strftime("%H:%M %d/%m/%Y") %>
        </span>
      </div>
    </div>

    <div class="stat-card">
      <div class="stat-icon">
        <i class="fas fa-door-open"></i>
      </div>
      <div class="stat-content">
        <span class="stat-label">Phòng</span>
        <span class="stat-value">
          <% if @smart_device.room.present? %>
            <%= link_to @smart_device.room.number, room_path(@smart_device.room), class: "text-decoration-none" %>
          <% else %>
            <span class="text-muted">Chưa được gán</span>
          <% end %>
        </span>
      </div>
    </div>
  </div>

  <div class="dashboard-sections">
    <div class="dashboard-section">
      <h2 class="section-title">Thông tin thiết bị</h2>
      <div class="section-content">
        <div class="info-card">
          <div class="info-row">
            <div class="info-label">Mã thiết bị:</div>
            <div class="info-value"><code><%= @smart_device.device_id %></code></div>
          </div>
          <div class="info-row">
            <div class="info-label">Tên hiển thị:</div>
            <div class="info-value"><%= @smart_device.name %></div>
          </div>
          <div class="info-row">
            <div class="info-label">Tòa nhà:</div>
            <div class="info-value">
              <% if @smart_device.building.present? %>
                <%= link_to @smart_device.building.name, building_path(@smart_device.building), class: "text-decoration-none" %>
              <% else %>
                <span class="text-muted">Không có</span>
              <% end %>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="dashboard-section">
      <h2 class="section-title">
        <% case @smart_device.device_type 
          when 'smart_lock' %>
          Điều khiển khóa
        <% when 'smart_switch' %>
          Điều khiển công tắc
        <% when 'temperature_sensor' %>
          Dữ liệu cảm biến
        <% else %>
          Điều khiển thiết bị
        <% end %>
      </h2>

      <div class="section-content">
        <% case @smart_device.device_type 
          when 'smart_lock' %>
          <div class="device-controls">
            <div class="control-card">
              <div class="control-icon">
                <i class="fas fa-unlock-alt"></i>
              </div>
              <div class="control-content">
                <h5>Mở khóa tạm thời</h5>
                <p>Mở khóa từ xa cho khách hoặc người thuê</p>
              </div>
              <div class="control-actions">
                <%= link_to unlock_door_smart_device_path(@smart_device), method: :post, class: "btn btn-warning btn-lg #{'disabled' unless @smart_device.online?}" do %>
                  <i class="fas fa-unlock me-2"></i> Mở khóa ngay
                <% end %>
              </div>
            </div>

            <div class="control-card">
              <div class="control-icon">
                <i class="fas fa-lock"></i>
              </div>
              <div class="control-content">
                <h5>Khóa cửa</h5>
                <p>Khóa cửa từ xa để đảm bảo an toàn</p>
              </div>
              <div class="control-actions">
                <%= link_to lock_door_smart_device_path(@smart_device), method: :post, class: "btn btn-success btn-lg #{'disabled' unless @smart_device.online?}" do %>
                  <i class="fas fa-lock me-2"></i> Khóa lại
                <% end %>
              </div>
            </div>
            
            <div class="control-card">
              <div class="control-icon">
                <i class="fas fa-users"></i>
              </div>
              <div class="control-content">
                <h5>Quản lý người dùng</h5>
                <p>Xem và quản lý quyền truy cập khóa</p>
              </div>
              <div class="control-actions">
                <%= link_to lock_users_smart_device_path(@smart_device), class: "btn btn-primary btn-lg" do %>
                  <i class="fas fa-user-lock me-2"></i> Người dùng
                <% end %>
              </div>
            </div>

            <div class="control-card">
              <div class="control-icon">
                <i class="fas fa-history"></i>
              </div>
              <div class="control-content">
                <h5>Lịch sử mở khóa</h5>
                <p>Xem nhật ký mở khóa chi tiết từ thiết bị</p>
              </div>
              <div class="control-actions">
                <%= link_to unlock_records_smart_device_path(@smart_device), class: "btn btn-info btn-lg" do %>
                  <i class="fas fa-list-alt me-2"></i> Xem lịch sử
                <% end %>
              </div>
            </div>
          </div>
          
          <% if @smart_device.online? %>
          <div class="lock-status mt-4">
            <h4 class="mb-3">Trạng thái khóa</h4>
            <div class="status-blocks">
              <div class="status-block">
                <div class="status-label">Trạng thái hiện tại</div>
                <div class="status-value <%= @smart_device.device_status == 'locked' ? 'text-danger' : 'text-success' %>">
                  <% if @smart_device.device_status == 'locked' %>
                    <i class="fas fa-lock me-1"></i> Đã khóa
                  <% else %>
                    <i class="fas fa-unlock me-1"></i> Đã mở
                  <% end %>
                </div>
              </div>
              
              <div class="status-block">
                <div class="status-label">Pin</div>
                <div class="status-value">
                  <% 
                    battery = @smart_device.device_data&.dig('battery_percentage') || 0
                    battery_class = ''
                    if battery > 70
                      battery_class = 'text-success'
                    elsif battery > 30
                      battery_class = 'text-warning'
                    else
                      battery_class = 'text-danger'
                    end
                  %>
                  <span class="<%= battery_class %>">
                    <i class="fas fa-battery-<%= 
                      if battery > 80
                        'full'
                      elsif battery > 60
                        'three-quarters'
                      elsif battery > 40
                        'half'
                      elsif battery > 20
                        'quarter'
                      else
                        'empty'
                      end
                    %> me-1"></i>
                    <%= battery %>%
                  </span>
                </div>
              </div>
            </div>
          </div>
          <% end %>

        <% when 'smart_switch' %>
          <div class="switch-control">
            <div class="text-center mb-4">
              <div class="device-status-indicator <%= @smart_device.device_status == 'on' ? 'status-on' : 'status-off' %>">
                <i class="fas <%= @smart_device.device_status == 'on' ? 'fa-toggle-on' : 'fa-toggle-off' %>"></i>
                <span>
                  <%= @smart_device.device_status == 'on' ? 'ĐANG BẬT' : 'ĐANG TẮT' %>
                </span>
              </div>
            </div>
            
            <div class="switch-buttons">
              <% if @smart_device.online? %>
                <%= link_to turn_on_smart_device_path(@smart_device), method: :post, class: "btn btn-lg btn-success #{'active' if @smart_device.device_status == 'on'}" do %>
                  <i class="fas fa-power-off me-2"></i> BẬT
                <% end %>
                <%= link_to turn_off_smart_device_path(@smart_device), method: :post, class: "btn btn-lg btn-outline-danger #{'active' if @smart_device.device_status == 'off'}" do %>
                  <i class="fas fa-power-off me-2"></i> TẮT
                <% end %>
              <% else %>
                <div class="alert alert-warning">
                  <i class="fas fa-exclamation-triangle me-2"></i>
                  Thiết bị đang offline. Không thể điều khiển.
                </div>
              <% end %>
            </div>
          </div>

        <% when 'temperature_sensor' %>
          <% if @smart_device.online? && @smart_device.device_data.present? %>
            <div class="sensor-data-display">
              <div class="sensor-card temperature">
                <div class="sensor-icon">
                  <i class="fas fa-temperature-high"></i>
                </div>
                <div class="sensor-value">
                  <%= @smart_device.device_data['temperature'] || '0' %><span class="unit">°C</span>
                </div>
                <div class="sensor-label">Nhiệt độ</div>
              </div>
              
              <% if @smart_device.device_data['humidity'].present? %>
              <div class="sensor-card humidity">
                <div class="sensor-icon">
                  <i class="fas fa-tint"></i>
                </div>
                <div class="sensor-value">
                  <%= @smart_device.device_data['humidity'] || '0' %><span class="unit">%</span>
                </div>
                <div class="sensor-label">Độ ẩm</div>
              </div>
              <% end %>
            </div>
          <% else %>
            <div class="alert alert-warning">
              <i class="fas fa-exclamation-triangle me-2"></i>
              Thiết bị offline hoặc không có dữ liệu. Không thể hiển thị thông số.
            </div>
          <% end %>
        <% else %>
          <div class="alert alert-info">
            <i class="fas fa-info-circle me-2"></i>
            Thiết bị này không có tùy chọn điều khiển cụ thể.
          </div>
        <% end %>
      </div>
    </div>

    <% if @smart_device.device_type == 'smart_lock' %>
    <div class="dashboard-section">
      <h2 class="section-title">Lịch sử hoạt động</h2>
      <div class="section-content">
        <% if @device_logs.present? %>
          <div class="table-responsive">
            <table class="data-table">
              <thead>
                <tr>
                  <th>Thời gian</th>
                  <th>Sự kiện</th>
                  <th>Người dùng</th>
                  <th>Ghi chú</th>
                </tr>
              </thead>
              <tbody>
                <% @device_logs.each do |log| %>
                  <tr>
                    <td><%= log.created_at.strftime("%H:%M %d/%m/%Y") %></td>
                    <td>
                      <span class="badge <%= log.event_type == 'unlock' ? 'bg-success' : 'bg-danger' %>">
                        <%= log.event_type == 'unlock' ? 'Mở khóa' : 'Khóa cửa' %>
                      </span>
                    </td>
                    <td><%= log.user_name.presence || 'Hệ thống' %></td>
                    <td><%= log.notes.presence || '-' %></td>
                  </tr>
                <% end %>
              </tbody>
            </table>
          </div>
        <% else %>
          <div class="alert alert-info">
            <i class="fas fa-info-circle me-2"></i>
            Chưa có hoạt động nào cho thiết bị này.
          </div>
        <% end %>
      </div>
    </div>
    <% end %>

    <div class="dashboard-section">
      <h2 class="section-title">Quản lý thiết bị</h2>
      <div class="section-content">
        <div class="device-management-buttons">
          <%= link_to edit_smart_device_path(@smart_device), class: "btn btn-outline-primary" do %>
            <i class="fas fa-edit me-1"></i> Chỉnh sửa
          <% end %>

          <button type="button" class="btn btn-outline-danger ms-2" data-bs-toggle="modal" data-bs-target="#deleteDeviceModal">
            <i class="fas fa-trash-alt me-1"></i> Xóa thiết bị
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Delete Modal -->
<div class="modal fade" id="deleteDeviceModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Xác nhận xóa thiết bị</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p>Bạn có chắc chắn muốn xóa thiết bị "<strong><%= @smart_device.name %></strong>"?</p>
        <p class="text-danger">Thao tác này không thể hoàn tác.</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
        <% if @smart_device.building.present? %>
          <%= link_to 'Xóa thiết bị', smart_device_path(@smart_device, redirect_to: 'building'), method: :delete, class: 'btn btn-danger' %>
        <% else %>
          <%= link_to 'Xóa thiết bị', smart_device_path(@smart_device), method: :delete, class: 'btn btn-danger' %>
        <% end %>
      </div>
    </div>
  </div>
</div>
