<% content_for :title, t('smart_devices.lock.unlock_record_title', name: @smart_device.name) %>

<div class="container-fluid px-4">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="mt-4">
      <i class="fas fa-history"></i>
      <%= t('smart_devices.lock.unlock_record_title', name: @smart_device.name) %>
    </h1>
    <div>
      <%= link_to smart_device_path(@smart_device), class: 'btn btn-outline-secondary me-2' do %>
        <i class="fas fa-chevron-left me-1"></i> <%= t('smart_devices.common.back_to_device') %>
      <% end %>
      
      <%= link_to sync_device_data_smart_device_path(@smart_device), method: :post, class: 'btn btn-info', data: { turbo_method: :post, turbo_confirm: t('smart_devices.confirm_sync') } do %>
        <i class="fas fa-sync me-1"></i> <%= t('smart_devices.sync_with_cloud') %>
      <% end %>
    </div>
  </div>

  <div class="row">
    <div class="col-md-4 mb-4">
      <div class="card border-0 shadow h-100">
        <div class="card-header py-3 d-flex justify-content-between align-items-center bg-white">
          <h6 class="m-0 font-weight-bold text-primary"><%= t('smart_devices.lock.filter') %></h6>
        </div>
        <div class="card-body">
          <%= form_with url: device_unlock_records_smart_device_path(@smart_device), method: :get, local: true, class: "mb-3", id: "filter-form" do |f| %>
            <div class="mb-3">
              <label class="form-label"><%= t('smart_devices.lock.time_period') %></label>
              <div class="input-group">
                <span class="input-group-text"><i class="fas fa-calendar"></i></span>
                <%= f.date_field :start_date, value: params[:start_date] || Date.today.beginning_of_month.strftime('%Y-%m-%d'), class: "form-control", placeholder: "Từ ngày" %>
                <span class="input-group-text">đến</span>
                <%= f.date_field :end_date, value: params[:end_date] || Date.today.strftime('%Y-%m-%d'), class: "form-control", placeholder: "Đến ngày" %>
              </div>
              <small class="form-text text-muted"><%= t('smart_devices.lock.date_filter_hint', default: 'Chọn khoảng thời gian để xem các bản ghi mở khóa.') %></small>
            </div>
            
            <div class="mb-3">
              <label class="form-label"><%= t('smart_devices.lock.user') %></label>
              <% 
                # Get distinct user_id and name combinations to avoid repetition
                user_options = @smart_device.device_users.select(:user_id, :name).distinct.map do |u|
                  ["#{u.name}", u.user_id]
                end
              %>
              <%= f.select :user_id, 
                  user_options,
                  { include_blank: "-- #{t('common.all')} --", selected: params[:user_id] },
                  { class: "form-select" } %>
            </div>
            
            <div class="mb-3">
              <label class="form-label"><%= t('smart_devices.lock.unlock_methods.method') %></label>
              <%= f.select :unlock_sn, 
                  @smart_device.device_users.where.not(unlock_sn: nil).distinct.pluck(:unlock_name, :unlock_sn),
                  { include_blank: "-- #{t('common.all')} --", selected: params[:unlock_sn] },
                  { class: "form-select" } %>
            </div>
            
            <div class="mb-3">
              <label class="form-label"><%= t('tenants.title') %></label>
              <%= f.select :tenant_id, 
                  DeviceUser.where(smart_device_id: @smart_device.id).where.not(tenant_id: nil).joins(:tenant).distinct.pluck('tenants.name', 'tenants.id'),
                  { include_blank: "-- #{t('common.all')} --", selected: params[:tenant_id] },
                  { class: "form-select" } %>
            </div>
            
            <div class="d-grid">
              <button type="submit" class="btn btn-primary">
                <i class="fas fa-search me-1"></i> <%= t('smart_devices.common.apply') %>
              </button>
            </div>
          <% end %>
          
          <div class="mt-4">
            <h6 class="mb-3"><%= t('smart_devices.lock.statistics', default: 'Statistics') %></h6>
            <div class="row g-0">
              <div class="col-6 border-end">
                <div class="p-3 text-center">
                  <h5 class="mb-0"><%= @total_count %></h5>
                  <small class="text-muted"><%= t('smart_devices.lock.total_records', default: 'Total Records') %></small>
                </div>
              </div>
              <div class="col-6">
                <div class="p-3 text-center">
                  <h5 class="mb-0"><%= @successful_count %></h5>
                  <small class="text-muted"><%= t('smart_devices.lock.successful_unlocks', default: 'Successful Unlocks') %></small>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-md-8">
      <div class="card border-0 shadow mb-4">
        <div class="card-header py-3 d-flex justify-content-between align-items-center bg-white">
          <h6 class="m-0 font-weight-bold text-primary"><%= t('smart_devices.history.activity_history') %></h6>
        </div>
        
        <div class="card-body">
          <% if @unlock_records.any? %>
            <div class="table-responsive">
              <table class="table table-hover align-middle">
                <thead class="table-light">
                  <tr>
                    <th><%= t('smart_devices.lock.timestamp') %></th>
                    <th><%= t('smart_devices.lock.user') %></th>
                    <th><%= t('smart_devices.lock.unlock_methods.method') %></th>
                    <th><%= t('smart_devices.lock.unlock_sn') %></th>
                    <th><%= t('smart_devices.lock.status') %></th>
                  </tr>
                </thead>
                <tbody>
                  <% @unlock_records.each do |record| %>
                    <tr>
                      <td>
                        <div class="fw-medium"><%= record.time.getlocal("+07:00").strftime("%Y-%m-%d") %></div>
                        <small class="text-muted"><%= record.time.getlocal("+07:00").strftime("%H:%M:%S") %></small>
                      </td>
                      <td>
                        <% if record.device_user %>
                          <div class="d-flex align-items-center">
                            <% if record.device_user.avatar_url.present? %>
                              <img src="<%= record.device_user.avatar_url %>" alt="<%= t('smart_devices.history.user_avatar') %>" class="rounded-circle me-2" style="width: 32px; height: 32px; object-fit: cover;">
                            <% else %>
                              <div class="rounded-circle bg-primary text-white d-flex align-items-center justify-content-center me-2" style="width: 32px; height: 32px;">
                                <%= record.device_user.name.first.upcase rescue '?' %>
                              </div>
                            <% end %>
                            <div>
                              <div class="fw-medium">
                                <%= record.device_user.name %>
                                <% if record.device_user.tenant %>
                                  <span class="badge bg-secondary ms-1"><%= t('tenants.title') %></span>
                                <% end %>
                              </div>
                              <small class="text-muted"><%= record.user_name %></small>
                            </div>
                          </div>
                        <% else %>
                          <%= record.user_name || t('smart_devices.history.unknown_user') %>
                        <% end %>
                      </td>
                      <td>
                        <% case record.unlock_method 
                           when "Vân tay", "Fingerprint" %>
                          <span class="badge bg-info bg-opacity-10 text-info border border-info border-opacity-25 px-2 py-1">
                            <i class="fas fa-fingerprint me-1"></i> <%= t('smart_devices.history.fingerprint') %>
                          </span>
                        <% when "Mật khẩu", "Password" %>
                          <span class="badge bg-primary bg-opacity-10 text-primary border border-primary border-opacity-25 px-2 py-1">
                            <i class="fas fa-key me-1"></i> <%= t('smart_devices.history.password') %>
                          </span>
                        <% when "Thẻ", "Card" %>
                          <span class="badge bg-warning bg-opacity-10 text-warning border border-warning border-opacity-25 px-2 py-1">
                            <i class="fas fa-id-card me-1"></i> <%= t('smart_devices.history.card') %>
                          </span>
                        <% when "Ứng dụng", "App" %>
                          <span class="badge bg-success bg-opacity-10 text-success border border-success border-opacity-25 px-2 py-1">
                            <i class="fas fa-mobile-alt me-1"></i> <%= t('smart_devices.history.app') %>
                          </span>
                        <% else %>
                          <span class="badge bg-secondary bg-opacity-10 text-secondary border border-secondary border-opacity-25 px-2 py-1">
                            <i class="fas fa-question-circle me-1"></i> <%= record.unlock_method %>
                          </span>
                        <% end %>
                      </td>
                      <td>
                        <% if record.raw_data && record.raw_data["status"] && record.raw_data["status"]["value"] %>
                          <span class="badge bg-secondary"><%= record.raw_data["status"]["value"] %></span>
                        <% else %>
                          <span class="text-muted">-</span>
                        <% end %>
                      </td>
                      <td>
                        <% if record.success %>
                          <span class="badge bg-success"><%= t('smart_devices.history.success') %></span>
                        <% else %>
                          <span class="badge bg-danger"><%= t('smart_devices.history.failed') %></span>
                        <% end %>
                      </td>
                    </tr>
                  <% end %>
                </tbody>
              </table>
            </div>
            
            <div class="d-flex justify-content-center mt-4">
              <%= will_paginate @unlock_records, 
                    renderer: BootstrapPaginationRenderer,
                    previous_label: '&laquo;', 
                    next_label: '&raquo;' %>
            </div>
            
            <div class="text-center text-muted mt-2">
              <small>
                <%= t('pagination.showing_entries', 
                    from: [@per_page * ((@unlock_records.current_page || 1) - 1) + 1, @total_count].min, 
                    to: [@per_page * (@unlock_records.current_page || 1), @total_count].min, 
                    total: @total_count,
                    default: 'Showing %{from} to %{to} of %{total} entries') %>
              </small>
            </div>
          <% else %>
            <div class="alert alert-info">
              <i class="fas fa-info-circle me-2"></i> 
              <%= t('smart_devices.lock.no_records_message') %>
              <%= link_to t('smart_devices.sync_with_cloud'), sync_device_data_smart_device_path(@smart_device), method: :post, class: "alert-link", data: { turbo_method: :post } %>
            </div>
          <% end %>
        </div>
      </div>
    </div>
  </div>
</div>

<% content_for :scripts do %>
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Handle form filtering
    const filterForm = document.getElementById('filter-form');
    if (filterForm) {
      const filterSelects = filterForm.querySelectorAll('select');
      if (filterSelects) {
        filterSelects.forEach(function(select) {
          select.addEventListener('change', function() {
            filterForm.submit();
          });
        });
      }
      
      // Add event listeners for date fields
      const startDateInput = filterForm.querySelector('input[name="start_date"]');
      const endDateInput = filterForm.querySelector('input[name="end_date"]');
      
      if (startDateInput) {
        startDateInput.addEventListener('change', function() {
          filterForm.submit();
        });
      }
      
      if (endDateInput) {
        endDateInput.addEventListener('change', function() {
          filterForm.submit();
        });
      }
    }
  });
</script>
<% end %>