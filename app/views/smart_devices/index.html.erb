<div class="dashboard">
  <div class="page-header">
    <h1 class="header-title">
      <i class="fas fa-fingerprint me-2"></i>
      <% if @building.present? %>
        <%= t('smart_devices.title') %> - <%= @building.name %>
      <% else %>
        <%= t('smart_devices.list') %>
      <% end %>
    </h1>
    <div class="header-actions">
      <% if @building.present? %>
        <%= link_to new_building_smart_device_path(@building), class: 'btn btn-primary' do %>
          <i class="fas fa-plus-circle me-1"></i> <%= t('smart_devices.new') %>
        <% end %>
      <% else %>
        <%= link_to new_smart_device_path, class: 'btn btn-primary' do %>
          <i class="fas fa-plus-circle me-1"></i> <%= t('smart_devices.new') %>
        <% end %>
      <% end %>
    </div>
  </div>

  <div class="card mb-4">
    <div class="card-body">
      <%= form_with url: @building.present? ? building_smart_devices_path(@building) : smart_devices_path, method: :get, class: 'search-form' do |f| %>
        <div class="filter-container">
          <!-- Device type filter -->
          <div class="filter-select-container">
            <%= f.select :device_type, 
              [
                [t('common.all_items', items: t('smart_devices.management.device_management')), ''], 
                [t('smart_devices.types.smart_lock'), 'smart_lock'], 
                [t('smart_devices.types.smart_switch'), 'smart_switch'], 
                [t('smart_devices.types.temperature_sensor'), 'temperature_sensor']
              ], 
              { selected: params[:device_type] }, 
              { class: 'form-select filter-select', id: 'device-type-filter' } 
            %>
          </div>
          
          <!-- Search input -->
          <div class="search-input-container">
            <%= f.text_field :search, value: params[:search], class: 'form-control', placeholder: t('common.search_by_name') %>
          </div>
          
          <!-- Action buttons -->
          <div class="filter-actions">
            <button type="submit" class="btn btn-primary filter-btn">
              <i class="fas fa-search me-1"></i><%= t('common.search', default: 'Tìm kiếm') %>
            </button>
            
            <% if params[:search].present? || params[:device_type].present? %>
              <%= link_to @building.present? ? building_smart_devices_path(@building) : smart_devices_path, class: 'btn btn-outline-secondary filter-clear-btn' do %>
                <i class="fas fa-times me-1"></i><%= t('common.clear', default: 'Xóa bộ lọc') %>
              <% end %>
            <% end %>
          </div>
        </div>
      <% end %>
    </div>
  </div>

  <div class="card">
    <div class="card-body">
      <% if @smart_devices.any? %>
        <div class="table-responsive">
          <table class="data-table">
            <thead>
              <tr>
                <th><%= t('smart_devices.common.name') %></th>
                <th><%= t('smart_devices.common.device_type') %></th>
                <th><%= t('smart_devices.common.room') %></th>
                <th><%= t('smart_devices.common.status') %></th>
                <th><%= t('common.actions') %></th>
              </tr>
            </thead>
            <tbody>
              <% @smart_devices.each do |device| %>
                <% 
                  device_icon = case device.device_type
                              when 'smart_lock'
                                'fa-lock'
                              when 'smart_switch'
                                'fa-toggle-on'
                              when 'temperature_sensor'
                                'fa-thermometer-half'
                              else
                                'fa-microchip'
                              end
                  
                  status_class = device.online? ? 'status-active' : 'status-inactive'
                %>
                <tr>
                  <td>
                    <div class="d-flex align-items-center">
                      <div class="device-icon me-2">
                        <i class="fas <%= device_icon %>"></i>
                      </div>
                      <div>
                        <%= device.name %>
                      </div>
                    </div>
                  </td>
                  <td>
                    <%= t("smart_devices.types.#{device.device_type}", default: device.device_type.humanize) %>
                  </td>
                  <td>
                    <% if device.room.present? %>
                      <%= link_to device.room.number, room_path(device.room) %>
                    <% else %>
                      <span class="text-muted"><%= t('smart_devices.common.not_assigned') %></span>
                    <% end %>
                  </td>
                  <td>
                    <span class="status-badge <%= status_class %>">
                      <% if device.online? %>
                        <i class="fas fa-circle me-1 status-icon"></i>
                        <%= t('smart_devices.common.online') %>
                        
                        <% if device.device_type == 'smart_lock' %>
                          <% if device.device_status == 'locked' %>
                            - <i class="fas fa-lock me-1"></i><%= t('smart_devices.lock.locked') %>
                          <% elsif device.device_status == 'unlocked' %>
                            - <i class="fas fa-unlock me-1"></i><%= t('smart_devices.lock.unlocked') %>
                          <% end %>
                        <% elsif device.device_type == 'smart_switch' %>
                          <% if device.device_status == 'on' %>
                            - <i class="fas fa-toggle-on me-1"></i><%= t('smart_devices.switch.on') %>
                          <% else %>
                            - <i class="fas fa-toggle-off me-1"></i><%= t('smart_devices.switch.off') %>
                          <% end %>
                        <% elsif device.device_type == 'temperature_sensor' && device.device_data.present? %>
                          <% if device.device_data['temperature'].present? %>
                            - <i class="fas fa-thermometer-half me-1"></i><%= device.device_data['temperature'] %>°C
                          <% end %>
                        <% end %>
                      <% else %>
                        <i class="fas fa-circle me-1 status-icon"></i>
                        <%= t('smart_devices.common.offline') %>
                      <% end %>
                    </span>
                  </td>
                  <td>
                    <div class="d-flex">
                      <%= link_to smart_device_path(device), class: 'btn btn-sm btn-light me-1' do %>
                        <i class="fas fa-eye"></i> <%= t('common.view') %>
                      <% end %>
                      
                      <% if device.device_type == 'smart_lock' && device.online? %>
                        <%= link_to unlock_door_smart_device_path(device), method: :post, class: 'btn btn-sm btn-light me-1', title: t('smart_devices.lock.temp_unlock') do %>
                          <i class="fas fa-unlock"></i>
                        <% end %>
                        
                        <%= link_to lock_door_smart_device_path(device), method: :post, class: 'btn btn-sm btn-light me-1', title: t('smart_devices.lock.lock_door') do %>
                          <i class="fas fa-lock"></i>
                        <% end %>
                      <% elsif device.device_type == 'smart_switch' && device.online? %>
                        <%= link_to turn_on_smart_device_path(device), method: :post, class: 'btn btn-sm btn-light me-1', title: t('smart_devices.switch.turn_on') do %>
                          <i class="fas fa-power-off"></i>
                        <% end %>
                        
                        <%= link_to turn_off_smart_device_path(device), method: :post, class: 'btn btn-sm btn-light me-1', title: t('smart_devices.switch.turn_off') do %>
                          <i class="fas fa-power-off"></i>
                        <% end %>
                      <% end %>
                      
                      <%= link_to edit_smart_device_path(device), class: 'btn btn-sm btn-light' do %>
                        <i class="fas fa-edit"></i> <%= t('common.edit') %>
                      <% end %>
                    </div>
                  </td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>

        <div class="d-flex justify-content-center mt-4">
          <%= paginate @smart_devices if @smart_devices.respond_to?(:total_pages) %>
        </div>
      <% else %>
        <div class="empty-state">
          <div class="empty-state-icon">
            <i class="fas fa-fingerprint"></i>
          </div>
          <h3><%= t('smart_devices.no_devices') %></h3>
          <p><%= t('smart_devices.no_devices_description', default: 'Add smart devices to manage them') %></p>
          <% if @building.present? %>
            <%= link_to new_building_smart_device_path(@building), class: 'btn btn-primary' do %>
              <i class="fas fa-plus-circle me-1"></i> <%= t('smart_devices.add') %>
            <% end %>
          <% else %>
            <%= link_to new_smart_device_path, class: 'btn btn-primary' do %>
              <i class="fas fa-plus-circle me-1"></i> <%= t('smart_devices.add') %>
            <% end %>
          <% end %>
        </div>
      <% end %>
    </div>
  </div>
</div>

<style>
  .device-icon {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 32px;
    height: 32px;
    border-radius: 4px;
    background-color: #f8f9fa;
  }
  
  .filter-container {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    align-items: center;
  }

  .search-input-container {
    flex: 3;
  }

  .filter-select-container {
    flex: 1;
    min-width: 200px;
  }

  .filter-actions {
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .status-badge {
    display: inline-flex;
    align-items: center;
    font-size: 0.8rem;
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
  }
  
  .status-active {
    background-color: #d4edda;
    color: #155724;
  }
  
  .status-inactive {
    background-color: #f8d7da;
    color: #721c24;
  }
  
  .status-icon {
    font-size: 8px;
    margin-right: 5px;
  }
  
  .empty-state {
    text-align: center;
    padding: 40px 0;
  }
  
  .empty-state-icon {
    font-size: 2.5rem;
    color: #adb5bd;
    margin-bottom: 1rem;
  }
  
  .empty-state h3 {
    margin-bottom: 0.5rem;
  }
  
  .empty-state p {
    color: #6c757d;
    margin-bottom: 1.5rem;
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Device switch toggle functionality for smart switches
    const deviceSwitches = document.querySelectorAll('.device-switch');
    
    deviceSwitches.forEach(function(switchEl) {
      switchEl.addEventListener('change', function() {
        const deviceId = this.dataset.deviceId;
        const isOn = this.checked;
        const label = this.nextElementSibling;
        
        label.textContent = '<%= t("smart_devices.common.loading") %>';
        
        fetch(`/smart_devices/${deviceId}/${isOn ? 'turn_on' : 'turn_off'}`, {
          method: 'POST',
          headers: {
            'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content,
            'Accept': 'application/json',
          },
          credentials: 'same-origin'
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            label.textContent = isOn ? '<%= t("smart_devices.switch.on") %>' : '<%= t("smart_devices.switch.off") %>';
          } else {
            this.checked = !isOn;
            label.textContent = !isOn ? '<%= t("smart_devices.switch.on") %>' : '<%= t("smart_devices.switch.off") %>';
            alert('<%= t("smart_devices.switch.control_error") %>');
          }
        })
        .catch(error => {
          console.error('Error:', error);
          this.checked = !isOn;
          label.textContent = !isOn ? '<%= t("smart_devices.switch.on") %>' : '<%= t("smart_devices.switch.off") %>';
          alert('<%= t("smart_devices.common.network_error") %>');
        });
      });
    });
  });
</script>
