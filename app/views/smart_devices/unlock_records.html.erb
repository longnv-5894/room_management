<h1>Lịch sử mở khóa - <%= @smart_device.name %></h1>

<div class="mb-3">
  <%= link_to 'Quay lại chi tiết thiết bị', smart_device_path(@smart_device), class: 'btn btn-secondary' %>
  
  <%= form_tag unlock_records_smart_device_path(@smart_device), method: :get, class: 'mt-3' do %>
    <div class="row align-items-end">
      <div class="col-md-3">
        <div class="form-group">
          <%= label_tag :days, "Xem dữ liệu của:" %>
          <%= select_tag :days, 
              options_for_select([
                ["7 ngày qua", "7"],
                ["30 ngày qua", "30"],
                ["90 ngày qua", "90"]
              ], params[:days] || "7"),
              class: "form-control" %>
        </div>
      </div>
      <div class="col-md-2">
        <%= submit_tag "Áp dụng", class: "btn btn-primary" %>
      </div>
    </div>
  <% end %>
</div>

<div class="card">
  <div class="card-header bg-primary text-white">
    <div class="d-flex justify-content-between align-items-center">
      <h5 class="mb-0">Lịch sử mở khóa</h5>
      <span class="badge bg-light text-dark">
        <% days = params[:days] || 7 %>
        <%= pluralize(days.to_i, "ngày") %> gần đây
      </span>
    </div>
  </div>
  <div class="card-body">
    <% if @unlock_records.present? && @unlock_records[:error].blank? && @unlock_records[:records].present? %>
      <div class="table-responsive">
        <table class="table table-striped table-hover">
          <thead>
            <tr>
              <th>Thời gian</th>
              <th>Người dùng</th>
              <th>Người dùng</th>
              <th>Phương thức</th>
              <th>Trạng thái</th>
            </tr>
          </thead>
          <tbody>
            <% @unlock_records[:records].each do |record| %>
              <tr>
                <td><%= record[:time] %></td>
                <td><%= record[:unlock_name] %></td>
                <td><%= record[:user] %></td>
                <td>
                  <% case record[:method] 
                     when "Vân tay" %>
                    <span class="badge bg-info"><i class="fas fa-fingerprint me-1"></i> <%= record[:method] %></span>
                  <% when "Mật khẩu" %>
                    <span class="badge bg-primary"><i class="fas fa-key me-1"></i> <%= record[:method] %></span>
                  <% when "Thẻ" %>
                    <span class="badge bg-warning text-dark"><i class="fas fa-id-card me-1"></i> <%= record[:method] %></span>
                  <% when "Ứng dụng" %>
                    <span class="badge bg-success"><i class="fas fa-mobile-alt me-1"></i> <%= record[:method] %></span>
                  <% when "Chìa khóa" %>
                    <span class="badge bg-secondary"><i class="fas fa-key me-1"></i> <%= record[:method] %></span>
                  <% when "Điều khiển từ xa" %>
                    <span class="badge bg-dark"><i class="fas fa-wifi me-1"></i> <%= record[:method] %></span>
                  <% else %>
                    <span class="badge bg-secondary"><i class="fas fa-question-circle me-1"></i> <%= record[:method] %></span>
                  <% end %>
                </td>
                <td>
                  <% if record[:success] %>
                    <span class="badge bg-success"><i class="fas fa-check-circle me-1"></i> Thành công</span>
                  <% else %>
                    <span class="badge bg-danger"><i class="fas fa-times-circle me-1"></i> Thất bại</span>
                  <% end %>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
      
      <div class="d-flex justify-content-between align-items-center mt-3">
        <div>
          <small class="text-muted">Tổng số: <%= @unlock_records[:count] || @unlock_records[:records].size %> bản ghi</small>
        </div>
        <% if @unlock_records[:has_more] %>
          <small class="text-muted">* Có nhiều bản ghi hơn, vui lòng sử dụng bộ lọc để xem chi tiết</small>
        <% end %>
      </div>
    <% elsif @unlock_records.present? && @unlock_records[:error].present? %>
      <div class="alert alert-warning">
        <i class="fas fa-exclamation-triangle me-2"></i>
        Lỗi khi lấy lịch sử mở khóa: <%= @unlock_records[:error] %>
      </div>
    <% elsif @unlock_records.present? && @unlock_records[:records].empty? %>
      <div class="alert alert-info">
        <i class="fas fa-info-circle me-2"></i>
        Không có bản ghi mở khóa nào trong khoảng thời gian đã chọn.
      </div>
    <% else %>
      <div class="alert alert-info">
        <i class="fas fa-spinner fa-spin me-2"></i>
        Đang tải dữ liệu lịch sử mở khóa...
      </div>
    <% end %>
  </div>
</div>