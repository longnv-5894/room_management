<div class="container-fluid px-4">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="mt-4"><%= t('smart_devices.lock.unlock_record_title', name: @smart_device.name) %></h1>
    <%= link_to smart_device_path(@smart_device), class: "btn btn-outline-secondary" do %>
      <i class="fas fa-arrow-left me-1"></i> <%= t('smart_devices.common.back_to_device') %>
    <% end %>
  </div>

  <div class="card mb-4 border-0 shadow-sm">
    <div class="card-header py-3">
      <%= form_tag unlock_records_smart_device_path(@smart_device), method: :get, id: 'filter-form' do %>
        <div class="row align-items-center">
          <div class="col-md-2">
            <h6 class="mb-0 text-primary"><i class="fas fa-filter me-2"></i><%= t('smart_devices.lock.filter') %></h6>
          </div>
          <div class="col-md-3 d-flex align-items-center mb-2 mb-md-0">
            <label for="days" class="form-label mb-0 me-3"><%= t('smart_devices.lock.time_period') %></label>
            <%= text_field_tag :days, params[:days] || 7, class: "form-control", style: "width: 80px;", placeholder: t('smart_devices.lock.days_placeholder') %>
          </div>
          <div class="col-md-3 mb-2 mb-md-0">
            <label for="user_id" class="form-label mb-0 me-2"><%= t('smart_devices.lock.user') %></label>
            <%= select_tag :user_id, 
                options_for_select(@smart_device.device_users.map { |u| [u.unlock_name || u.name, u.user_id] }, params[:user_id]), 
                include_blank: "-- #{t('common.all')} --", 
                class: "form-select" %>
          </div>
          <div class="col-md-2 mb-2 mb-md-0">
            <label for="unlock_sn" class="form-label mb-0 me-2"><%= t('smart_devices.lock.unlock_methods.method') %></label>
            <%= select_tag :unlock_sn, 
                options_for_select(@smart_device.device_users.where.not(unlock_sn: nil).distinct.pluck(:unlock_name, :unlock_sn), params[:unlock_sn]), 
                include_blank: "-- #{t('common.all')} --", 
                class: "form-select" %>
          </div>
          <div class="col-md-2 mb-2 mb-md-0">
            <label for="tenant_id" class="form-label mb-0 me-2"><%= t('tenants.title') %></label>
            <%= select_tag :tenant_id, 
                options_for_select(Tenant.joins(:device_users).where(device_users: {smart_device_id: @smart_device.id}).distinct.pluck(:name, :id), params[:tenant_id]), 
                include_blank: "-- #{t('common.all')} --", 
                class: "form-select" %>
          </div>
          <div class="col-md-2">
            <%= button_tag type: "submit", class: "btn btn-primary" do %>
              <i class="fas fa-search me-1"></i> <%= t('smart_devices.common.apply') %>
            <% end %>
          </div>
        </div>
      <% end %>
    </div>
  </div>

  <div class="card mb-4 border-0 shadow">
    <div class="card-header bg-white d-flex justify-content-between align-items-center py-3">
      <h5 class="text-primary mb-0">
        <i class="fas fa-history me-1"></i> <%= t('smart_devices.lock.unlock_history') %>
      </h5>
      <% days = params[:days] || 7 %>
      <span class="badge bg-light text-dark border">
        <i class="far fa-calendar-alt me-1"></i>
        <%= t('smart_devices.common.days_ago', count: days) %>
      </span>
    </div>
    
    <div class="card-body p-0">
      <% if @unlock_records.present? && @unlock_records[:error].blank? && @unlock_records[:records].present? %>
        <div class="table-responsive">
          <table class="table table-hover align-middle mb-0">
            <thead class="table-light">
              <tr>
                <th class="border-0 ps-4"><%= t('smart_devices.lock.timestamp') %></th>
                <th class="border-0"><%= t('smart_devices.lock.user') %></th>
                <th class="border-0"><%= t('smart_devices.lock.method') %></th>
                <th class="border-0"><%= t('smart_devices.lock.unlock_sn') %></th>
                <th class="border-0"><%= t('smart_devices.lock.status') %></th>
              </tr>
            </thead>
            <tbody>
              <% @unlock_records[:records].each do |record| %>
                <tr>
                  <td class="ps-4">
                    <div class="fw-medium"><%= record[:time].split(' ')[0] %></div>
                    <small class="text-muted"><%= record[:time].split(' ')[1] %></small>
                  </td>
                  <td><%= record[:unlock_name] || record[:user] %></td>
                  <td>
                    <% case record[:method] 
                       when "Vân tay" %>
                      <span class="badge bg-info bg-opacity-10 text-info border border-info border-opacity-25 px-2 py-1">
                        <i class="fas fa-fingerprint me-1"></i><%= t('smart_devices.lock.unlock_methods.fingerprint') %>
                      </span>
                    <% when "Mật khẩu" %>
                      <span class="badge bg-primary bg-opacity-10 text-primary border border-primary border-opacity-25 px-2 py-1">
                        <i class="fas fa-key me-1"></i><%= t('smart_devices.lock.unlock_methods.password') %>
                      </span>
                    <% when "Thẻ" %>
                      <span class="badge bg-warning bg-opacity-10 text-warning border border-warning border-opacity-25 px-2 py-1">
                        <i class="fas fa-id-card me-1"></i><%= t('smart_devices.lock.unlock_methods.card') %>
                      </span>
                    <% when "Ứng dụng" %>
                      <span class="badge bg-success bg-opacity-10 text-success border border-success border-opacity-25 px-2 py-1">
                        <i class="fas fa-mobile-alt me-1"></i><%= t('smart_devices.lock.unlock_methods.app') %>
                      </span>
                    <% when "Chìa khóa" %>
                      <span class="badge bg-secondary bg-opacity-10 text-secondary border border-secondary border-opacity-25 px-2 py-1">
                        <i class="fas fa-key me-1"></i><%= t('smart_devices.lock.unlock_methods.key') %>
                      </span>
                    <% when "Từ xa" %>
                      <span class="badge bg-purple bg-opacity-10 text-purple border border-purple border-opacity-25 px-2 py-1">
                        <i class="fas fa-wifi me-1"></i><%= t('smart_devices.lock.unlock_methods.remote') %>
                      </span>
                    <% else %>
                      <span class="badge bg-secondary bg-opacity-10 text-secondary border border-secondary border-opacity-25 px-2 py-1">
                        <i class="fas fa-question-circle me-1"></i><%= record[:method] %>
                      </span>
                    <% end %>
                  </td>
                  <td>
                    <% if record[:raw_data] && record[:raw_data]["status"] && record[:raw_data]["status"]["value"] %>
                      <span class="badge bg-secondary"><%= record[:raw_data]["status"]["value"] %></span>
                    <% else %>
                      <span class="text-muted">-</span>
                    <% end %>
                  </td>
                  <td>
                    <% if record[:success] %>
                      <span class="badge bg-success bg-opacity-10 text-success border border-success border-opacity-25 px-2 py-1">
                        <i class="fas fa-check-circle me-1"></i><%= t('smart_devices.lock.unlock_statuses.success') %>
                      </span>
                    <% else %>
                      <span class="badge bg-danger bg-opacity-10 text-danger border border-danger border-opacity-25 px-2 py-1">
                        <i class="fas fa-times-circle me-1"></i><%= t('smart_devices.lock.unlock_statuses.failure') %>
                      </span>
                    <% end %>
                  </td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>
        
        <div class="d-flex justify-content-between align-items-center p-3 border-top">
          <div>
            <small class="text-muted">
              <i class="fas fa-info-circle me-1"></i>
              <%= t('smart_devices.lock.showing_records', shown: @unlock_records[:records].size, total: @unlock_records[:count] || @unlock_records[:records].size) %>
            </small>
          </div>
          
          <% if @unlock_records[:has_more] %>
            <div>
              <%= form_tag unlock_records_smart_device_path(@smart_device), method: :get, class: 'load-more-form' do %>
                <%= hidden_field_tag :days, params[:days] || 7 %>
                <%= hidden_field_tag :page, (@unlock_records[:page_no] || 1) + 1 %>
                <%= hidden_field_tag :page_size, params[:page_size] || 50 %>
                <%= hidden_field_tag :user_id, params[:user_id] if params[:user_id].present? %>
                <%= hidden_field_tag :unlock_sn, params[:unlock_sn] if params[:unlock_sn].present? %>
                <%= hidden_field_tag :tenant_id, params[:tenant_id] if params[:tenant_id].present? %>
                <%= hidden_field_tag :load_more, true %>
                <%= button_tag type: "submit", class: "btn btn-outline-primary btn-sm", id: "load-more-btn" do %>
                  <i class="fas fa-sync me-1"></i> <%= t('smart_devices.lock.load_more') %>
                <% end %>
              <% end %>
            </div>
          <% end %>
        </div>
      
      <% elsif @unlock_records.present? && @unlock_records[:error].present? %>
        <div class="alert alert-warning m-4">
          <i class="fas fa-exclamation-triangle me-2"></i>
          <strong><%= t('smart_devices.lock.error_title') %></strong> <%= @unlock_records[:error] %>
        </div>
      <% elsif @unlock_records.present? && @unlock_records[:records].empty? %>
        <div class="alert alert-info m-4">
          <i class="fas fa-info-circle me-2"></i>
          <strong><%= t('common.info') %>:</strong> <%= t('smart_devices.lock.no_records_message') %>
        </div>
      <% else %>
        <div class="text-center p-5">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden"><%= t('smart_devices.common.loading') %></span>
          </div>
          <p class="mt-2 text-muted"><%= t('smart_devices.common.loading') %></p>
        </div>
      <% end %>
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Form tải thêm dữ liệu
    const loadMoreForm = document.querySelector('.load-more-form');
    
    if (loadMoreForm) {
      loadMoreForm.addEventListener('submit', function(e) {
        const loadMoreBtn = document.getElementById('load-more-btn');
        if (loadMoreBtn) {
          loadMoreBtn.disabled = true;
          loadMoreBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span> <%= t('common.loading') %>';
        }
      });
    }
    
    // Form filter
    const filterForm = document.getElementById('filter-form');
    if (filterForm) {
      const filterSelects = filterForm.querySelectorAll('select');
      if (filterSelects) {
        filterSelects.forEach(function(select) {
          select.addEventListener('change', function() {
            const pageInput = document.createElement('input');
            pageInput.type = 'hidden';
            pageInput.name = 'page';
            pageInput.value = '1';
            filterForm.appendChild(pageInput);
          });
        });
      }
    }
  });
</script>