<div class="page-header">
  <h1 class="header-title"><%= t('room_assignments.edit') %></h1>
  <div class="header-actions">
    <%= link_to t('common.cancel'), room_assignment_path(@room_assignment), class: "btn btn-outline" %>
  </div>
</div>

<div class="form-container">
  <%= form_with(model: @room_assignment, local: true) do |form| %>
    <% if @room_assignment.errors.any? %>
      <div class="alert alert-danger">
        <h2><%= pluralize(@room_assignment.errors.count, "error") %> <%= t('common.form_error') %>:</h2>
        <ul>
          <% @room_assignment.errors.full_messages.each do |message| %>
            <li><%= message %></li>
          <% end %>
        </ul>
      </div>
    <% end %>

    <div class="form-group">
      <%= form.label :room_id, t('room_assignments.room'), class: "form-label" %>
      <div class="d-flex align-items-center">
        <%= form.collection_select :room_id, @available_rooms, :id, :number, 
                                { prompt: t('room_assignments.select_room', default: 'Select a room') }, 
                                { class: "form-select", id: "room_assignment_room_id", required: true } %>
        <div id="room-status-indicator" class="ms-2 d-none">
          <span class="badge bg-info">
            <i class="fas fa-users me-1"></i> <span id="tenant-count">0</span> <%= t('tenants.tenant', count: 0) %>
          </span>
        </div>
      </div>
      <small id="room-status-help" class="form-text text-muted mt-1 d-none">
        <%= t('room_assignments.add_to_occupied') %>
      </small>
    </div>

    <div class="form-group">
      <%= form.label :tenant_id, t('room_assignments.tenant'), class: "form-label" %>
      <div class="d-flex align-items-center mb-2">
        <div class="form-check form-switch">
          <input class="form-check-input" type="checkbox" id="show-all-tenants">
          <label class="form-check-label text-muted" for="show-all-tenants">
            <%= t('room_assignments.show_all_tenants') %>
          </label>
        </div>
      </div>
      <div class="d-flex align-items-center">
        <%= form.collection_select :tenant_id, @available_tenants, :id, :name, 
                                { prompt: t('room_assignments.select_tenant', default: 'Select a tenant') }, 
                                { class: "form-select", id: "tenant-select", required: true } %>
        <div id="tenant-badge" class="ms-2">
          <span class="badge bg-success">
            <i class="fas fa-check-circle me-1"></i> <%= t('room_assignments.unassigned_only') %>
          </span>
        </div>
      </div>
      <small class="form-text text-muted mt-1">
        <i class="fas fa-info-circle"></i> 
        <%= t('room_assignments.edit_single_note') %>
      </small>
    </div>

    <div class="form-group">
      <%= form.label :start_date, t('room_assignments.start_date'), class: "form-label" %>
      <%= form.date_field :start_date, class: "form-control", required: true %>
    </div>

    <div class="form-group">
      <%= form.label :end_date, t('room_assignments.end_date'), class: "form-label" %>
      <%= form.date_field :end_date, class: "form-control" %>
      <small class="form-text text-muted">
        <%= t('common.optional') %>
      </small>
    </div>

    <div class="form-group">
      <%= form.label :deposit_amount, t('room_assignments.deposit_amount') + " (VND)", class: "form-label" %>
      <%= form.number_field :deposit_amount, class: "form-control", min: 0 %>
    </div>

    <div class="form-group">
      <%= form.label :active, t('room_assignments.status'), class: "form-label" %>
      <div class="form-check">
        <%= form.check_box :active, class: "form-check-input" %>
        <%= form.label :active, t('room_assignments.active'), class: "form-check-label" %>
      </div>
    </div>

    <div class="form-group">
      <%= form.label :notes, t('common.notes'), class: "form-label" %>
      <%= form.text_area :notes, class: "form-control", rows: 3 %>
    </div>

    <div class="form-actions">
      <%= form.submit t('common.update'), class: "btn btn-primary" %>
    </div>
  <% end %>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Room status data
    const roomStatus = {
      <% @available_rooms.each do |room| %>
        <%= room.id %>: {
          status: "<%= room.status %>",
          tenantCount: <%= room.tenants.joins(:room_assignments).where(room_assignments: { active: true, room_id: room.id }).count %>
        },
      <% end %>
    };

    // Update room status display when room selection changes
    const roomSelector = document.getElementById('room_assignment_room_id');
    const statusIndicator = document.getElementById('room-status-indicator');
    const tenantCountElement = document.getElementById('tenant-count');
    const statusHelpText = document.getElementById('room-status-help');

    roomSelector.addEventListener('change', function() {
      const roomId = this.value;
      
      if (roomId && roomStatus[roomId]) {
        const room = roomStatus[roomId];
        
        if (room.status === 'occupied' && room.tenantCount > 0) {
          // Show occupied room indicator
          statusIndicator.classList.remove('d-none');
          statusHelpText.classList.remove('d-none');
          tenantCountElement.textContent = room.tenantCount;
        } else {
          // Hide indicator for available rooms
          statusIndicator.classList.add('d-none');
          statusHelpText.classList.add('d-none');
        }
      } else {
        // Hide indicator when no room is selected
        statusIndicator.classList.add('d-none');
        statusHelpText.classList.add('d-none');
      }
    });

    // Trigger change event if room is pre-selected
    if (roomSelector.value) {
      roomSelector.dispatchEvent(new Event('change'));
    }
    
    // Handle tenant toggle switch
    const showAllTenantsToggle = document.getElementById('show-all-tenants');
    const tenantBadge = document.getElementById('tenant-badge');
    const tenantSelect = document.getElementById('tenant-select');
    
    showAllTenantsToggle.addEventListener('change', function() {
      if (this.checked) {
        // Show all tenants (fetch via AJAX)
        fetchAllTenants();
        
        // Update the badge
        tenantBadge.innerHTML = `
          <span class="badge bg-warning text-dark">
            <i class="fas fa-users me-1"></i> <%= t('room_assignments.all_tenants') %>
          </span>
        `;
      } else {
        // Reset to only unassigned tenants - for edit form, we keep the current tenant
        location.reload();
      }
    });
    
    // Function to fetch all tenants via AJAX
    function fetchAllTenants() {
      fetch('/tenants.json')
        .then(response => response.json())
        .then(data => {
          // Save the current selection
          const currentSelection = tenantSelect.value;
          
          // Clear the current options
          tenantSelect.innerHTML = '';
          
          // Add the prompt option
          const promptOption = document.createElement('option');
          promptOption.value = '';
          promptOption.textContent = '<%= t('room_assignments.select_tenant') %>';
          tenantSelect.appendChild(promptOption);
          
          // Add all tenants
          data.forEach(tenant => {
            const option = document.createElement('option');
            option.value = tenant.id;
            option.textContent = tenant.name;
            
            // Mark assigned tenants with a special text
            if (tenant.has_active_assignment && tenant.id != <%= @room_assignment.tenant_id %>) {
              option.textContent += ' <%= t('room_assignments.currently_assigned') %>';
              option.classList.add('text-muted');
            }
            
            tenantSelect.appendChild(option);
          });
          
          // Restore the selection if possible
          if (currentSelection) {
            tenantSelect.value = currentSelection;
          }
        })
        .catch(error => {
          console.error('Error fetching tenants:', error);
        });
    }
  });
</script>
